#!/usr/bin/env node

var path = require('path')
var exec = require('./../util/exec')
var logger = require('./../util/logger')
var program = require('commander')
var slush = require.resolve('slush/bin/slush')

program.option('--china', '切换到 taobao 镜像')
  .option('--registry [registry url]', '指定镜像')
  .parse(process.argv)

var name = 'cooking-' + (program.args[0] || 'vue')
var template = 'slush-' + name

console.log()
process.on('exit', function () {
  console.log()
})

var installTemplate = function (template) {
  var show = '\'' + template + '\''
  var errorMessage = show + ' is not a valid template.'
  var options = [
    'install',
    template,
    '--prefix',
    path.join(__dirname, '..')
  ]

  if (program.china) {
    options.push('--registry=https://registry.npm.taobao.org')
  } else if (program.registry) {
    options.push('--registry=' + program.registry)
  }

  logger.log('downloading ' + show)
  exec('npm', options, {
    stdio: 'inherit'
  })
  logger.success('template install success!')
}

var generator = function (name) {
  logger.log('generator project')
  exec(slush, [name], {
    stdio: 'inherit',
    errorMessage: 'slush runtime error'
  })
}

try {
  require.resolve(path.join(template.split('@')[0], 'package.json'))
} catch(e) {
  installTemplate(template)
}

generator(name.split('@')[0])
